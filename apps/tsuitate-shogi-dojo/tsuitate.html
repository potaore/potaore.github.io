<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>ついたて将棋道場</title>
    <link rel="stylesheet" type="text/css" href="tsuitate.css">
    <script>
      var gameApi = {}; 
      var api = {};
      var graphicApi = {};
      var kifuApi = {};
    </script>
    <script src="./underscore/underscore-min.js"></script>
    <script src="./jquery/jquery-2.1.4.min.js"></script>
    <script src="./socket.io/socket.io.js"></script>
    <script src="./player.js"></script>    
    <script>
      var socket = null;
      var getSocket = function () {
        if(socket === null || socket === undefined) {
          socket = io.connect('http://localhost:8888');
          socket.on('message', function(msg){
            console.log(msg);
          });

          //lobby api
          socket.on('receivePlayingGames', function(data){
            $("#table-rooms-body").html("");
            _( data.playingGames ).each( function(game) {
              tr = $("<tr>");
              tr.append( $("<td>").append(game.startDateTime) );
              tr.append( $("<td>").append(game.id) );
              tr.append( $("<td><input type='button' value='対局を観戦する' onClick='watch()' /></td>") );
              $("#table-rooms-body").append(tr);
            });
          });

          //player api
          socket.on('noticePlayerNumber', function(playerNumber){
            $("#game").show();
            $("#room").show();
            $("#lobby").hide();
            gameApi.startGame(playerNumber);
            console.log("noticePlayerNumber : " + playerNumber);
            if( playerNumber == 2 ) {
              graphicApi.flipBord(true);
            } else {
              graphicApi.flipBord(false);
            }
          });
          socket.on('moveKoma', function(command){
            gameApi.moveKoma(command);
          });
          socket.on('putKoma', function(command){
            gameApi.putKoma(command);
          });

          socket.on('game', function(command){
            gameApi.putKoma(command);
          });

          socket.on('gameMessage', function(message) {
            if (message.type == "plain") {
              $("#gameMessageArea").html("");
              _(message.texts).each(function(text) {
                $("#gameMessageArea").append($('<li>').text(text));
              });
              $("#gameMessageArea").hide();
              $("#gameMessageArea").show(200);
            } else if (message.type == "modal") {
              $("#gameMessageArea").html("");
              $("#modal-message").html("");
              $("#modal-window").show()
              $("#modal-overlay").show()
              $("#modal-window").css( { "background-color": "#FFFFFF", "opacity" : 0 } )
              $("#modal-overlay").css( { "background-color": "#000000", "opacity" : 0 } )
              $("#modal-window").animate( { "background-color": "#FFFFFF", "opacity" : 0.95 }, 120 )
              $("#modal-overlay").animate( { "background-color": "#000000", "opacity" : 0.3 }, 120 )
              _(message.texts).each(function(text) {
                $("#gameMessageArea").append($('<li>').text(text));
                $("#modal-message").append($('<div>').text(text));
              });
            }

            if(message.error) {
              graphicApi.afterHideModal = exitRoom;
            }
          });

          socket.on('command', function(command){
            console.log("command : " + command);
            gameApi.doCommand(command);
          });
          socket.on('endGame', function( info ) {
            $("#game").show();
            $("#room").show();
            $("#roomWatchMenu").show();
            gameApi.endGame(info);
            kifuApi.replayKifu(info.kifu);
            kifuApi.toEnd();
          });

          //watcher api
          socket.on('kifu', function( info ) {
            $("#game").show();
            $("#room").show();
            $("#room-watch-menu").show();
            kifuApi.replayKifu(info.kifu);
            kifuApi.toEnd();
          });
          socket.on('distributeKifu', function( info ) {
            kifuApi.addKifu(info.te);
            kifuApi.toEnd();
          });
        }
        return socket;
      }
      var start = function() {
        socket = getSocket();
        socket.emit('room', { method : "startGame"} ); 
        $("#roomWatchMenu").hide();
        $('#kifuSelectBox').html("");
        $("#kifuInfoDiv").hide();
        $("#kifuReplayDiv").hide();
      };
      var watch= function() {
        socket = getSocket();
        graphicApi.clearTable();
        socket.emit('room',  { method : "watch" } );
        $("#lobby").hide();
        $("#roomWatchMenu").show();
      };
      var getPlayingGames = function() {
        $("#lobby-menu").hide();
        $("#lobby-watch").show();
        socket.emit('getPlayingGames', ""); 
      }
      var exitRoom = function() {
        $("#lobby-menu").hide();
        $("#lobby").show();
        $("#lobby-watch").show();
        $("#game").hide();
        $("#room").hide();
        
        socket.emit('room', { method : "exitRoom" } ); 
        socket.emit('getPlayingGames', ""); 
      }
      var connect = function() {
        socket = getSocket();
        $("#lobby-login").show();
        $("#lobby-logout").hide();
      }

      var showLobby = function() {
        $("#lobby").show();
        $("#lobby-login").show();
        $("#lobby-menu").show();
        $("#lobby-logout").hide();
        $("#room").hide();
        $("#roomWatchMenu").hide();
        $("#lobby-watch").hide();
      }
    </script>
  </head>
  <body>
    <div id='title'>
      <div id='title-inner'><h1>ついたて将棋道場</h1></div>
    </div>
    <div>
      <div id='lobby'>
        <div id='lobby-logout'>
          <input type='button' class='menu-button' value='接続' onClick='connect()' />
          <input type='button' class='menu-button' value='help' onClick='' />
        </div>
        <div id='lobby-login'>
          <div id='lobby-menu'>
            <input type='button' class='menu-button' value='対戦する' onClick='start()' />
            <input type='button' class='menu-button' value='観戦する' onClick='getPlayingGames()' />
          </div>
          <div id='lobby-watch'>
            <input type='button' class='menu-button' value='戻る' onClick='showLobby()' />
            <input type='button' class='menu-button' value='更新' onClick='getPlayingGames()' />
            <table id='table-rooms'>
              <thead>
              <tr>
                <th>開始時刻</th>
                <th>対局ID</th>
                <th></th>
              </tr>
              </thead>
              <tbody id='table-rooms-body'>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="room">
        <div id='roomWatchMenu'>
          <input type='button' value='退室する' onClick='exitRoom()' />
        </div>
        <div id="game" class="game">
          <div id="komadai2" class="komadai"></div>
          <div id="gameInfo2" class="gameInfo"></div>
          <div id="board"></div>
          <img id="boardImg" class='board' src='./images/board/japanese-chess-b02.jpg'>
          <div id="gameInfo1" class="gameInfo"></div>
          <div id="komadai1" class="komadai"></div>
          <div id="kifuInfoDiv" >
            <select size="19" id="kifuSelectBox"></select>
          </div>
          <div id="kifuReplayDiv">
            <input type='button' id='toStartButton' class='control-button' value='←←' onClick='kifuApi.toStart();' />
            <input type='button' id='backButton'    class='control-button' value='←'   onClick='kifuApi.back();' />
            <input type='button' id='nextButton'    class='control-button' value='→'   onClick='kifuApi.next();' />
            <input type='button' id='toEndButton'   class='control-button' value='→→' onClick='kifuApi.toEnd();' />
          </div>
          <div id="gameMessageAreaDiv" class="gameMessage"><ui id="gameMessageArea"></ui></div>
        </div>
        <div id="messagesDiv">
          <ul id="messages"></ul>
        </div>

        <div id="nariDiv" class="modal-window">
          <div>成りますか？</div>
          <input type='button' id='nariButton'    class='confirm-button' value='成'   onClick='graphicApi.nari(true);' />
          <input type='button' id='notNariButton' class='confirm-button' value='不成' onClick='graphicApi.nari(false);' />
        </div>
        <div id="modal-window" class="modal-window">
          <div id="modal-message"></div>
          <input type='button' id='modalConfirmButton' class='confirm-button' value='OK' onClick='graphicApi.hideModal();' />
        </div>
        <div id="modal-overlay"></div>
      </div>
      </div>
  </body>
</html>